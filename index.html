import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    onAuthStateChanged, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut,
    signInWithCustomToken,
    signInAnonymously
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc, 
    collection, 
    getDocs,
    addDoc,
    serverTimestamp,
    query,
    where
} from 'firebase/firestore';

// --- 重要：如何修復 Firestore 權限錯誤 (Missing or insufficient permissions) ---
//
// 您遇到的這個錯誤不是程式碼 bug，而是您的 Firebase Firestore 資料庫安全規則設定過於嚴格所導致的。
// 為了讓這個原型應用程式能夠順利讀寫資料，您需要更新您在 Firebase 網站上的設定。
//
// 請依照以下步驟操作：
// 1. 前往您的 Firebase 專案控制台 (https://console.firebase.google.com/)。
// 2. 選擇您的專案 (nwcom-security-system)。
// 3. 在左側選單中，點擊「建構」>「Firestore Database」。
// 4. 點擊上方的「規則」(Rules) 標籤頁。
// 5. 將編輯器中現有的規則全部刪除，然後貼上以下的規則：
//
// rules_version = '2';
// service cloud.firestore {
//   match /databases/{database}/documents {
//     // 允許所有已登入的使用者讀取和寫入 `apps` 集合下的任何資料
//     // 警告：這是一個較為寬鬆的規則，主要用於開發和測試階段。
//     // 在正式上線的產品中，您應該根據需求設定更精細、更嚴格的安全規則。
//     match /apps/{appId}/{document=**} {
//       allow read, write: if request.auth != null;
//     }
//   }
// }
//
// 6. 點擊「發布」(Publish) 按鈕。
//
// 完成以上步驟後，回到此頁面並重新整理，錯誤應該就會解決。
// ---

// --- Firebase 設定 ---
const firebaseConfig = {
  apiKey: "AIzaSyAUWD4qFvV88umGvzyozFuyo7WhT6QidsU",
  authDomain: "nwcom-security-system.firebaseapp.com",
  projectId: "nwcom-security-system",
  storageBucket: "nwcom-security-system.firebasestorage.app",
  messagingSenderId: "439911862368",
  appId: "1:439911862368:web:64dd8bf7a8e44d81687305",
  measurementId: "G-H8GLDCW27X"
};

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-duty-management-app';

// --- 初始化 Firebase ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- SVG 圖示組件 ---
const Icon = ({ name, className }) => {
    const icons = {
        dashboard: <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />,
        users: <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M9 3a4 4 0 110 8 4 4 0 010-8zM23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" />,
        schedule: <path d="M8 2v4M16 2v4M3 10h18M3 6h18M3 14h18M3 18h18" />,
        records: <path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2zM22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z" />,
        profile: <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" />,
        logout: <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9" />,
        clock: <path d="M22 12h-4M2 12H6M12 2v4M12 22v-4M6.34 6.34l2.83 2.83M14.83 14.83l2.83 2.83M6.34 17.66l2.83-2.83M14.83 9.17l2.83-2.83" />,
        check: <path d="M20 6L9 17l-5-5" />,
        plus: <path d="M12 5v14M5 12h14" />,
    };
    return (
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
            className={className}
        >
            {icons[name]}
        </svg>
    );
};


// --- 主應用程式組件 ---
const App = () => {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
            if (firebaseUser) {
                try {
                    const userDocRef = doc(db, `apps/${appId}/users`, firebaseUser.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        setUser({ uid: firebaseUser.uid, email: firebaseUser.email, ...userDocSnap.data() });
                    } else {
                        // 在Firestore中找不到用戶資料，可能是新用戶或資料錯誤
                        setUser({ uid: firebaseUser.uid, email: firebaseUser.email, role: 'Employee', name: '新用戶' });
                    }
                } catch (dbError) {
                     console.error("Error fetching user data:", dbError);
                     setError("無法讀取使用者資料。請檢查 Firestore 安全規則。");
                     setUser(null); // 登出用戶以避免不一致狀態
                }
            } else {
                setUser(null);
            }
            setLoading(false);
        });

        return () => unsubscribe();
    }, []);

    const handleSignOut = async () => {
        try {
            await signOut(auth);
            setUser(null);
        } catch (error) {
            console.error("Sign out error", error);
            setError("登出時發生錯誤。");
        }
    };

    if (loading) {
        return <div className="flex items-center justify-center min-h-screen bg-gray-100"><div className="text-xl font-semibold">載入中...</div></div>;
    }

    return (
        <div className="min-h-screen bg-gray-50">
            {error && <div className="p-4 text-white bg-red-500">{error}</div>}
            {user ? <MainLayout user={user} onSignOut={handleSignOut} /> : <AuthScreen setError={setError} />}
        </div>
    );
};

// --- 登入/註冊畫面 ---
const AuthScreen = ({ setError }) => {
    const [isLogin, setIsLogin] = useState(false); // 改為 false，預設顯示註冊畫面
    const [email, setEmail] = useState('test@test.com'); // 預填測試帳號
    const [password, setPassword] = useState('123456'); // 預填測試密碼
    const [name, setName] = useState('測試管理員'); // 預填姓名
    const [role, setRole] = useState('Admin'); // 預設為 Admin 角色

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        if (!/^[a-zA-Z0-9@._-]+$/.test(email)) {
            setError('帳號只能包含英數文字與 @._-');
            return;
        }

        try {
            if (isLogin) {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUser = userCredential.user;
                // 將使用者資料寫入 Firestore
                await setDoc(doc(db, `apps/${appId}/users`, newUser.uid), {
                    name: name,
                    email: newUser.email,
                    role: role,
                    createdAt: serverTimestamp()
                });
            }
        } catch (error) {
            console.error(error);
            if(error.code === 'auth/email-already-in-use'){
                setError('此電子郵件已被註冊。');
            } else if(error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found'){
                setError('帳號或密碼錯誤。');
            } else if(error.code === 'auth/weak-password'){
                setError('密碼長度需至少6個字元。');
            } else {
                setError('發生錯誤，請稍後再試。');
            }
        }
    };

    return (
        <div className="flex items-center justify-center min-h-screen bg-gray-100">
            <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                <h2 className="text-2xl font-bold text-center text-gray-800">西北保全勤務管理系統</h2>
                <form onSubmit={handleSubmit} className="space-y-6">
                    {!isLogin && (
                         <>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">姓名</label>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} required className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-gray-700">角色 (僅供測試)</label>
                                <select value={role} onChange={(e) => setRole(e.target.value)} className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Employee">員工</option>
                                    <option value="Junior Manager">初階管理者</option>
                                    <option value="Manager">高階管理者</option>
                                    <option value="Admin">管理員</option>
                                </select>
                            </div>
                        </>
                    )}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">帳號 (Email)</label>
                        <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">密碼</label>
                        <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required className="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div>
                        <button type="submit" className="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            {isLogin ? '登入' : '註冊'}
                        </button>
                    </div>
                </form>
                <p className="text-sm text-center">
                    <a href="#" onClick={() => setIsLogin(!isLogin)} className="font-medium text-blue-600 hover:text-blue-500">
                        {isLogin ? '還沒有帳號？前往註冊' : '已經有帳號？前往登入'}
                    </a>
                </p>
            </div>
        </div>
    );
};

// --- 主畫面佈局 ---
const MainLayout = ({ user, onSignOut }) => {
    const [activeView, setActiveView] = useState('dashboard');
    const [isSidebarOpen, setIsSidebarOpen] = useState(true);

    const roleNameMapping = {
        'Admin': '管理員',
        'Manager': '高階管理者',
        'Junior Manager': '初階管理者',
        'Employee': '員工'
    };
    
    const navItems = useMemo(() => {
        const baseNav = [{ id: 'dashboard', name: '儀表板', icon: 'dashboard' }];
        const roleNavs = {
            Admin: [
                ...baseNav,
                { id: 'userManagement', name: '帳號管理', icon: 'users' },
            ],
            Manager: [
                ...baseNav,
                { id: 'scheduling', name: '勤務排班', icon: 'schedule' },
                { id: 'records', name: '獎懲登錄', icon: 'records' },
            ],
            'Junior Manager': [
                ...baseNav,
                { id: 'scheduling', name: '勤務排班', icon: 'schedule' },
                { id: 'records', name: '獎懲登錄', icon: 'records' },
            ],
            Employee: [
                ...baseNav,
                { id: 'mySchedule', name: '我的班表', icon: 'schedule' },
                { id: 'myRecords', name: '我的獎懲', icon: 'records' },
            ],
        };
        return roleNavs[user.role] || baseNav;
    }, [user.role]);

    const renderContent = () => {
        switch (activeView) {
            case 'dashboard':
                // 根據角色顯示不同的儀表板
                if (user.role === 'Admin') return <AdminDashboard user={user} />;
                if (user.role === 'Manager' || user.role === 'Junior Manager') return <ManagerDashboard user={user} />;
                if (user.role === 'Employee') return <EmployeeDashboard user={user} />;
                return <div>儀表板</div>;
            case 'userManagement':
                return <UserManagement />;
            // 其他 view 的 case
            default:
                return <div className="p-6">{navItems.find(item => item.id === activeView)?.name || '頁面'}內容尚在建置中...</div>;
        }
    };
    
    return (
        <div className="flex h-screen">
            {/* Sidebar */}
            <aside className={`bg-gray-800 text-white flex flex-col transition-all duration-300 ${isSidebarOpen ? 'w-64' : 'w-20'}`}>
                <div className="flex items-center justify-center h-16 border-b border-gray-700">
                    <h1 className={`font-bold text-lg ${isSidebarOpen ? '' : 'hidden'}`}>西北保全</h1>
                </div>
                <nav className="flex-1 px-4 py-4 space-y-2">
                    {navItems.map(item => (
                         <a
                            key={item.id}
                            href="#"
                            onClick={() => setActiveView(item.id)}
                            className={`flex items-center px-4 py-2.5 rounded-md transition-colors ${activeView === item.id ? 'bg-blue-600' : 'hover:bg-gray-700'}`}
                        >
                            <Icon name={item.icon} className="w-6 h-6" />
                            <span className={`ml-4 ${isSidebarOpen ? '' : 'hidden'}`}>{item.name}</span>
                        </a>
                    ))}
                </nav>
                <div className="px-4 py-4 border-t border-gray-700">
                     <a
                        href="#"
                        onClick={onSignOut}
                        className="flex items-center px-4 py-2.5 rounded-md hover:bg-gray-700"
                    >
                        <Icon name="logout" className="w-6 h-6" />
                        <span className={`ml-4 ${isSidebarOpen ? '' : 'hidden'}`}>登出</span>
                    </a>
                </div>
            </aside>
            {/* Main Content */}
            <div className="flex-1 flex flex-col">
                <header className="flex items-center justify-between h-16 px-6 bg-white border-b">
                    <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 -ml-2 rounded-md focus:outline-none focus:ring">
                       <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div className="flex items-center space-x-4">
                        <Icon name="profile" className="w-6 h-6" />
                        <div>
                            <p className="font-semibold">{user.name}</p>
                            <p className="text-sm text-gray-500">{roleNameMapping[user.role]}</p>
                        </div>
                    </div>
                </header>
                <main className="flex-1 p-6 overflow-y-auto bg-gray-100">
                    {renderContent()}
                </main>
            </div>
        </div>
    );
};

// --- 各角色儀表板 ---

// 員工儀表板
const EmployeeDashboard = ({ user }) => {
    const [clockInStatus, setClockInStatus] = useState(null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');

    const handleClockIn = async () => {
        setLoading(true);
        setError('');
        if (!navigator.geolocation) {
            setError("您的瀏覽器不支援GPS定位。");
            setLoading(false);
            return;
        }

        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const { latitude, longitude } = position.coords;
                try {
                    await addDoc(collection(db, `apps/${appId}/clockIns`), {
                        userId: user.uid,
                        userName: user.name,
                        timestamp: serverTimestamp(),
                        type: 'in',
                        location: { latitude, longitude }
                    });
                    setClockInStatus(`打卡成功！時間: ${new Date().toLocaleTimeString()}, 位置: (緯度${latitude.toFixed(4)}, 經度${longitude.toFixed(4)})`);
                } catch (e) {
                    console.error("Error adding document: ", e);
                    setError("打卡失敗，無法寫入資料庫。");
                } finally {
                    setLoading(false);
                }
            },
            (err) => {
                setError(`GPS定位失敗: ${err.message}`);
                setLoading(false);
            }
        );
    };

    return (
        <div>
            <h2 className="text-2xl font-bold mb-4">員工儀表板</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="p-6 bg-white rounded-lg shadow">
                    <h3 className="text-lg font-semibold mb-2">GPS 打卡</h3>
                    <p className="text-gray-600 mb-4">點擊按鈕以您目前的位置進行打卡簽到。</p>
                    <button 
                        onClick={handleClockIn} 
                        disabled={loading}
                        className="flex items-center justify-center px-4 py-2 font-bold text-white bg-green-600 rounded-md hover:bg-green-700 disabled:bg-gray-400"
                    >
                        <Icon name="clock" className="w-5 h-5 mr-2" />
                        {loading ? '定位中...' : '簽到打卡'}
                    </button>
                    {error && <p className="text-red-500 mt-2">{error}</p>}
                    {clockInStatus && <p className="text-green-600 mt-2 flex items-center"><Icon name="check" className="w-5 h-5 mr-2" />{clockInStatus}</p>}
                </div>
                 <div className="p-6 bg-white rounded-lg shadow">
                    <h3 className="text-lg font-semibold mb-2">即時考核分數 (示意)</h3>
                    <p className="text-5xl font-bold text-blue-600">88</p>
                    <p className="text-gray-500 mt-2">分數將根據您的勤務表現與獎懲記錄即時更新。</p>
                </div>
            </div>
        </div>
    );
};

// 管理者儀表板 (高階/初階)
const ManagerDashboard = ({ user }) => {
    return (
        <div>
            <h2 className="text-2xl font-bold mb-4">管理者儀表板</h2>
            <div className="p-6 bg-white rounded-lg shadow">
                <h3 className="text-lg font-semibold mb-2">團隊總覽</h3>
                <p>這裡將顯示您所管轄團隊的整體勤務狀況、出勤率與績效摘要。</p>
                {/* 可以在這裡加入圖表或數據摘要 */}
            </div>
        </div>
    );
};

// 系統管理員儀表板
const AdminDashboard = ({ user }) => {
    return (
        <div>
            <h2 className="text-2xl font-bold mb-4">系統管理員儀表板</h2>
            <div className="p-6 bg-white rounded-lg shadow">
                <h3 className="text-lg font-semibold mb-2">系統狀態</h3>
                <p>這裡將顯示系統的整體使用狀況、用戶總數、以及資料庫用量等關鍵指標。</p>
            </div>
        </div>
    );
};


// 帳號管理頁面
const UserManagement = () => {
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(true);

    const fetchUsers = useCallback(async () => {
        setLoading(true);
        try {
            const usersCollectionRef = collection(db, `apps/${appId}/users`);
            const querySnapshot = await getDocs(usersCollectionRef);
            const userList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setUsers(userList);
        } catch (error) {
            console.error("Error fetching users:", error);
        } finally {
            setLoading(false);
        }
    }, []);

    useEffect(() => {
        fetchUsers();
    }, [fetchUsers]);
    
     const roleNameMapping = {
        'Admin': '管理員',
        'Manager': '高階管理者',
        'Junior Manager': '初階管理者',
        'Employee': '員工'
    };


    if (loading) return <div>讀取使用者資料中...</div>;

    return (
        <div>
            <div className="flex justify-between items-center mb-4">
                 <h2 className="text-2xl font-bold">帳號管理</h2>
                 <button className="flex items-center px-4 py-2 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    <Icon name="plus" className="w-5 h-5 mr-2" />
                    新增使用者
                </button>
            </div>
           
            <div className="bg-white rounded-lg shadow overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">角色</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">註冊時間</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {users.map(user => (
                            <tr key={user.id}>
                                <td className="px-6 py-4 whitespace-nowrap">{user.name}</td>
                                <td className="px-6 py-4 whitespace-nowrap">{user.email}</td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                    <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                      {roleNameMapping[user.role] || user.role}
                                    </span>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

export default App;
