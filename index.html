<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西北保全勤務管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 避免 Tailwind CSS 預設樣式影響，確保 body 和 html 佔滿整個視窗高度 */
        html, body, #app {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* 防止水平滾動 */
        }
        /* 微調滾動條樣式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* 簡單的 Modal 樣式 */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app">
        <!-- 應用程式將會渲染於此 -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-xl font-semibold">載入中...</div>
        </div>
    </div>
    <div id="modal-container"></div>


    <script type="module">
        // =====================================================================================
        // !! 重要：Firebase 安全規則更新 !!
        //
        // 為了支援「帳號登入」與「大頭照上傳」功能，請更新您的 Firebase 專案安全規則。
        //
        // --- 1. Firestore Database Rules ---
        // 前往 Firebase Console -> Firestore Database -> Rules (規則) 頁面，貼上以下內容：
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /apps/{appId}/users/{userId} {
              allow read: if true;
              allow write: if request.auth != null; // 允許登入者新增或修改員工
            }
            match /apps/{appId}/{collection}/{docId=**} {
              allow read, write: if request.auth != null;
            }
          }
        }
        */
        //
        // --- 2. Cloud Storage Rules ---
        // 前往 Firebase Console -> Storage -> Rules (規則) 頁面，貼上以下內容：
        /*
        rules_version = '2';
        service firebase.storage {
          match /b/{bucket}/o {
            match /profile_pictures/{userId}/{fileName} {
              allow read: if true;
              allow write: if request.auth != null; // 允許登入者上傳
            }
          }
        }
        */
        //
        // --- 3. Firestore Index (索引) ---
        // 為了支援按建立時間排序，您可能需要在 Firestore 建立索引。
        // 如果您在瀏覽器的開發者工具 Console 中看到 'failed-precondition' 錯誤，
        // 錯誤訊息中會包含一個直接建立索引的連結，點擊該連結即可自動完成設定。
        // =====================================================================================

        // --- Firebase SDK 匯入 ---
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection,
            getDocs,
            addDoc,
            deleteDoc,
            serverTimestamp,
            query,
            orderBy,
            where
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // --- Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyAUWD4qFvV88umGvzyozFuyo7WhT6QidsU",
            authDomain: "nwcom-security-system.firebaseapp.com",
            projectId: "nwcom-security-system",
            storageBucket: "nwcom-security-system.appspot.com",
            messagingSenderId: "439911862368",
            appId: "1:439911862368:web:64dd8bf7a8e44d81687305",
            measurementId: "G-H8GLDCW27X"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-duty-management-app';

        // --- 初始化 Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- 應用程式狀態管理 ---
        let state = {
            user: null,
            loading: true,
            error: '',
            activeView: 'dashboard',
            isSidebarOpen: false,
            users: [],
            schedules: [],
            records: [],
            tasks: [],
            communities: [],
        };

        // --- 渲染目標 ---
        const appContainer = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');

        // --- SVG 圖示組件 ---
        const Icon = (name, className = '') => {
            const icons = {
                dashboard: `<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />`,
                users: `<path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M9 3a4 4 0 110 8 4 4 0 010-8zM23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" />`,
                schedule: `<path d="M8 2v4M16 2v4M3 10h18M3 6h18M3 14h18M3 18h18" />`,
                communities: `<path d="M8 20V10c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v10M2 20h20M4 20V4a2 2 0 012-2h12a2 2 0 012 2v16"/>`,
                records: `<path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2zM22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z" />`,
                tasks: `<path d="M22 11.08V12a10 10 0 11-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" />`,
                reports: `<path d="M18 20H6a2 2 0 01-2-2V6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2zM6 12h12" /><line x1="12" y1="16" x2="12" y2="8" />`,
                settings: `<path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.18,5.18C8.59,5.42,8.06,5.74,7.56,6.12L5.17,5.16C4.95,5.09,4.7,5.16,4.59,5.38L2.67,8.7 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.78,11.36,4.76,11.68,4.76,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.42,2.37 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.42-2.37c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.2,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>`,
                logout: `<path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9" />`,
                plus: `<path d="M12 5v14M5 12h14" />`,
                upload: `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" />`,
                download: `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" />`,
                edit: `<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />`,
                trash: `<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>`,
                menu: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>`
            };
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${icons[name] || ''}</svg>`;
        };
        
        // --- 主渲染流程 ---
        async function renderApp() {
            if (state.loading) {
                appContainer.innerHTML = `<div class="flex items-center justify-center min-h-screen bg-gray-100"><div class="text-xl font-semibold">載入中...</div></div>`;
                return;
            }
            if (state.user) {
                appContainer.innerHTML = MainLayout();
                await renderContent(state.activeView);
            } else {
                appContainer.innerHTML = AuthScreen();
            }
        }
        
        // --- 組件模板 ---
        const AuthScreen = () => {
             return `
                <div class="flex items-center justify-center min-h-screen bg-gray-100 px-4">
                    <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-center text-gray-800">西北保全勤務管理系統</h2>
                        <div class="text-center text-gray-500 text-sm">請登入以繼續</div>
                        <form id="auth-form" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">帳號</label>
                                <input type="text" id="username" value="test" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">密碼</label>
                                <input type="password" id="password" value="123456" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <button type="submit" class="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    登入
                                </button>
                            </div>
                        </form>
                        <div id="auth-feedback" class="text-center text-sm text-red-500 h-4"></div>
                    </div>
                </div>
            `;
        };

        const MainLayout = () => {
            const roleNameMapping = { 'Admin': '管理員', 'Manager': '高階管理者', 'Junior Manager': '初階管理者', 'Employee': '員工' };
            const fullNavItems = [
                { id: 'dashboard', name: '儀表板', icon: 'dashboard' },
                { id: 'scheduling', name: '勤務排班', icon: 'schedule' },
                { id: 'records', name: '獎懲登錄', icon: 'records' },
                { id: 'tasks', name: '任務指派', icon: 'tasks' },
                { id: 'reports', name: '數據報表', icon: 'reports' },
                { id: 'userManagement', name: '帳號管理', icon: 'users' },
                { id: 'communities', name: '社區管理', icon: 'communities' },
                { id: 'settings', name: '系統設定', icon: 'settings' },
            ];
            
            return `
                <div class="relative flex h-screen bg-gray-50 overflow-hidden">
                    <div id="sidebar-backdrop" class="${state.isSidebarOpen ? 'fixed' : 'hidden'} inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>
                    <aside id="main-sidebar" class="bg-gray-800 text-white flex flex-col w-64 fixed inset-y-0 left-0 z-30
                                 transform transition-transform duration-300 ease-in-out 
                                 ${state.isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} 
                                 md:relative md:translate-x-0">
                        <div class="flex items-center justify-center h-16 border-b border-gray-700">
                            <h1 class="font-bold text-lg">西北保全</h1>
                        </div>
                        <nav id="main-nav" class="flex-1 px-4 py-4 space-y-2">
                            ${fullNavItems.map(item => `
                                <a href="#" data-view="${item.id}" class="nav-link flex items-center px-4 py-2.5 rounded-md transition-colors ${state.activeView === item.id ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                    ${Icon(item.icon, 'w-6 h-6')}
                                    <span class="ml-4">${item.name}</span>
                                </a>
                            `).join('')}
                        </nav>
                        <div class="px-4 py-4 border-t border-gray-700">
                            <a href="#" id="signout-btn" class="flex items-center w-full px-4 py-2.5 rounded-md hover:bg-gray-700">
                                ${Icon('logout', 'w-6 h-6')}
                                <span class="ml-4">登出</span>
                            </a>
                        </div>
                    </aside>
                    
                    <div class="flex-1 flex flex-col">
                        <header class="flex items-center justify-between h-16 px-4 bg-white border-b">
                            <button id="toggle-sidebar" class="p-2 -ml-2 rounded-md md:hidden focus:outline-none focus:ring">
                                ${Icon('menu', 'w-6 h-6')}
                            </button>
                            <div class="hidden md:block"></div> <!-- 佔位符 -->
                            <div class="flex items-center space-x-4">
                                <img class="h-8 w-8 rounded-full object-cover" src="${state.user.photoURL || `https://ui-avatars.com/api/?name=${state.user.name}&background=random`}" alt="${state.user.name}">
                                <div class="text-right">
                                    <p class="font-semibold text-sm">${state.user.name}</p>
                                    <p class="text-xs text-gray-500">${roleNameMapping[state.user.role]}</p>
                                </div>
                            </div>
                        </header>
                        <main id="main-content" class="flex-1 p-4 md:p-6 overflow-y-auto bg-gray-100">
                           <!-- 內容將由 JS 動態載入 -->
                        </main>
                    </div>
                </div>
            `;
        };

        async function renderContent(view) {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            
            mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="text-gray-500">載入頁面中...</div></div>`;

            switch (view) {
                case 'dashboard':
                    if (state.user.role === 'Admin') mainContent.innerHTML = AdminDashboard();
                    else mainContent.innerHTML = EmployeeDashboard();
                    break;
                case 'scheduling':
                    await fetchSchedules();
                    mainContent.innerHTML = SchedulingScreen();
                    break;
                case 'records':
                    await fetchAllUsers();
                    await fetchRecords();
                    mainContent.innerHTML = RecordsScreen();
                    break;
                case 'tasks':
                    await fetchAllUsers();
                    await fetchTasks();
                    mainContent.innerHTML = TasksScreen();
                    break;
                case 'reports':
                    mainContent.innerHTML = ReportsScreen();
                    break;
                case 'userManagement':
                    await fetchAllUsers();
                    mainContent.innerHTML = UserManagement();
                    break;
                case 'communities':
                    await fetchCommunities();
                    mainContent.innerHTML = CommunitiesScreen();
                    break;
                case 'settings':
                    mainContent.innerHTML = SettingsScreen();
                    break;
                default:
                    mainContent.innerHTML = `<div class="p-6">頁面內容尚在建置中...</div>`;
            }
        }

        // --- 各功能頁面模板 ---
        const EmployeeDashboard = () => `<div><h2 class="text-2xl font-bold mb-4">員工儀表板</h2></div>`;
        const AdminDashboard = () => `<div><h2 class="text-2xl font-bold mb-4">系統管理員儀表板</h2></div>`;
        const SchedulingScreen = () => `<div><h2 class="text-2xl font-bold mb-4">勤務排班</h2><p>此頁面尚在建置中。</p></div>`;
        const RecordsScreen = () => `<div><h2 class="text-2xl font-bold mb-4">獎懲登錄</h2><p>此頁面尚在建置中。</p></div>`;
        const TasksScreen = () => `<div><h2 class="text-2xl font-bold mb-4">任務指派</h2><p>此頁面尚在建置中。</p></div>`;
        const ReportsScreen = () => `<div><h2 class="text-2xl font-bold mb-4">數據報表</h2><p>此頁面尚在建置中。</p></div>`;
        const SettingsScreen = () => `<div><h2 class="text-2xl font-bold mb-4">系統設定</h2><p>此頁面尚在建置中。</p></div>`;
        
        const UserManagement = () => {
             const roleNameMapping = { 'Admin': '管理員', 'Manager': '高階管理者', 'Junior Manager': '初階管理者', 'Employee': '員工' };
             const statusNameMapping = { active: '在職', inactive: '非在職', terminated: '離職' };
             const statusColorMapping = { active: 'bg-green-100 text-green-800', inactive: 'bg-yellow-100 text-yellow-800', terminated: 'bg-red-100 text-red-800' };

             return `
                <div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                        <h2 class="text-2xl font-bold">帳號管理</h2>
                        <div class="flex flex-wrap gap-2">
                            <button id="add-user-btn" class="flex items-center px-3 py-2 text-sm font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700">
                                ${Icon('plus', 'w-4 h-4 mr-2')} 新增員工
                            </button>
                            <button id="export-csv-btn" class="flex items-center px-3 py-2 text-sm font-bold text-white bg-green-600 rounded-md hover:bg-green-700">
                                ${Icon('download', 'w-4 h-4 mr-2')} 匯出 CSV
                            </button>
                            <label class="flex items-center px-3 py-2 text-sm font-bold text-white bg-yellow-500 rounded-md hover:bg-yellow-600 cursor-pointer">
                                ${Icon('upload', 'w-4 h-4 mr-2')} 匯入 CSV
                                <input type="file" id="import-csv-input" class="hidden" accept=".csv">
                            </label>
                        </div>
                    </div>
                    <div class="space-y-4">
                        ${state.users.length > 0 ? state.users.map(user => `
                            <div class="bg-white rounded-lg shadow p-4">
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start">
                                    <div class="flex items-start gap-4">
                                        <img class="h-16 w-16 rounded-full object-cover flex-shrink-0" src="${user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || 'User')}&background=random`}" alt="${user.name}">
                                        <div class="flex-grow">
                                            <p class="font-bold text-lg text-gray-800">${user.name || 'N/A'}</p>
                                            <p class="text-sm text-gray-500">${user.employeeId ? `員工編號: ${user.employeeId}` : '無編號'}</p>
                                            <span class="mt-1 px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorMapping[user.status] || 'bg-gray-100 text-gray-800'}">
                                                ${statusNameMapping[user.status] || '未知'}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 mt-4 sm:mt-0 flex items-center gap-2">
                                        <button data-userid="${user.id}" class="edit-user-btn p-2 text-blue-600 hover:text-blue-800">${Icon('edit', 'w-5 h-5')}</button>
                                        <button data-userid="${user.id}" data-username="${user.name || '該用戶'}" class="delete-user-btn p-2 text-red-600 hover:text-red-800">${Icon('trash', 'w-5 h-5')}</button>
                                    </div>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-2 text-sm text-gray-700">
                                    <div><strong>角色:</strong> ${roleNameMapping[user.role] || 'N/A'}</div>
                                    <div><strong>手機:</strong> ${user.phoneNumber || 'N/A'}</div>
                                    <div><strong>身分證:</strong> ${user.nationalId || 'N/A'}</div>
                                    <div><strong>生日:</strong> ${user.dob || 'N/A'}</div>
                                    <div class="sm:col-span-2"><strong>服務社區:</strong> ${user.serviceCommunity || 'N/A'}</div>
                                    <div class="sm:col-span-full"><strong>證照:</strong> <span class="text-gray-600">${user.certifications || '無'}</span></div>
                                    <div class="sm:col-span-full"><strong>備註:</strong> <span class="text-gray-600">${user.remarks || '無'}</span></div>
                                </div>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 py-8">目前沒有任何員工資料。</p>'}
                    </div>
                </div>
             `;
        };
        
        const CommunitiesScreen = () => {
             return `
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">社區管理</h2>
                        <button id="add-community-btn" class="flex items-center px-4 py-2 text-sm font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700">
                            ${Icon('plus', 'w-4 h-4 mr-2')} 新增社區
                        </button>
                    </div>
                     <div class="space-y-4">
                        ${state.communities.length > 0 ? state.communities.map(comm => `
                            <div class="bg-white rounded-lg shadow p-4">
                               <p class="font-bold text-lg text-gray-800">${comm.name || 'N/A'}</p>
                               <p class="text-sm text-gray-500">${comm.communityId ? `社區編號: ${comm.communityId}` : '無編號'}</p>
                               <div class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm text-gray-700">
                                    <div><strong>區域:</strong> ${comm.region || 'N/A'}</div>
                                    <div><strong>戶數:</strong> ${comm.householdCount || 'N/A'}</div>
                                    <div class="sm:col-span-2"><strong>地址:</strong> ${comm.address || 'N/A'}</div>
                                    <div class="sm:col-span-2"><strong>委員名單:</strong> 
                                        <ul class="list-disc list-inside ml-4 mt-1">
                                            ${(comm.committee && comm.committee.length > 0) ? comm.committee.map(c => `<li>${c.title}: ${c.name}</li>`).join('') : '<span>無</span>'}
                                        </ul>
                                    </div>
                               </div>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 py-8">目前沒有任何社區資料。</p>'}
                    </div>
                </div>
            `;
        };

        // --- 事件監聽 (使用事件代理) ---
        function setupEventListeners() {
            document.body.addEventListener('submit', e => {
                if (e.target.id === 'auth-form') handleAuthSubmit(e);
                if (e.target.id === 'user-modal-form') handleUserSubmit(e);
                if (e.target.id === 'community-modal-form') handleCommunitySubmit(e);
            });

            document.body.addEventListener('click', async e => {
                const target = e.target;
                const navLink = target.closest('.nav-link');
                if (navLink) {
                    e.preventDefault();
                    const view = navLink.dataset.view;
                    if (state.activeView !== view) {
                        state.activeView = view;
                        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('bg-blue-600'));
                        navLink.classList.add('bg-blue-600');
                        await renderContent(view);
                    }
                    if (window.innerWidth < 768) { 
                        state.isSidebarOpen = false;
                        document.getElementById('main-sidebar')?.classList.add('-translate-x-full');
                        document.getElementById('sidebar-backdrop')?.classList.add('hidden');
                    }
                    return;
                }

                if (target.closest('#toggle-sidebar')) {
                    state.isSidebarOpen = !state.isSidebarOpen;
                    document.getElementById('main-sidebar')?.classList.toggle('-translate-x-full');
                    document.getElementById('sidebar-backdrop')?.classList.toggle('hidden');
                    return;
                }

                if (target.closest('#sidebar-backdrop') || target.closest('#signout-btn')) {
                    if (target.closest('#signout-btn')) handleSignOut();
                    else {
                        state.isSidebarOpen = false;
                        document.getElementById('main-sidebar')?.classList.add('-translate-x-full');
                        document.getElementById('sidebar-backdrop')?.classList.add('hidden');
                    }
                    return;
                }
                
                if (target.closest('#add-user-btn')) showUserModal();
                const editBtn = target.closest('.edit-user-btn');
                if (editBtn) {
                    const userId = editBtn.dataset.userid;
                    const userToEdit = state.users.find(u => u.id === userId);
                    if (userToEdit) showUserModal(userToEdit);
                }
                 const deleteBtn = target.closest('.delete-user-btn');
                if (deleteBtn) {
                    const userId = deleteBtn.dataset.userid;
                    const userName = deleteBtn.dataset.username;
                    showDeleteConfirmModal(userId, userName);
                }

                if (target.closest('#export-csv-btn')) handleExportCSV();

                if (target.closest('#add-community-btn')) showCommunityModal();
                if (target.closest('.add-committee-member')) addCommitteeMemberRow();
                const removeBtn = target.closest('.remove-committee-member');
                if (removeBtn) removeBtn.parentElement.parentElement.remove();
            });

            document.body.addEventListener('change', e => {
                if (e.target.id === 'import-csv-input') handleImportCSV(e);
            });
        }
        
        // --- Modal 相關函式 ---
        function showUserModal(user = null) {
            const isEditMode = user !== null;
            const title = isEditMode ? '編輯員工資料' : '新增員工';
            const roleOptions = ['Admin', 'Manager', 'Junior Manager', 'Employee'];
            const roleNameMapping = { 'Admin': '管理員', 'Manager': '高階管理者', 'Junior Manager': '初階管理者', 'Employee': '員工' };
            const statusOptions = { active: '在職', inactive: '非在職', terminated: '離職' };


            modalContainer.innerHTML = `
                <div class="modal-backdrop" id="user-modal-backdrop">
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">${title}</h3>
                        <form id="user-modal-form" class="space-y-4">
                            <input type="hidden" id="userId" value="${isEditMode ? user.id : ''}">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                                <div class="md:col-span-1 flex flex-col items-center">
                                    <img id="avatar-preview" class="h-24 w-24 rounded-full object-cover mb-2" src="${user?.photoURL || 'https://placehold.co/100x100/EFEFEF/AAAAAA?text=照片'}">
                                    <label class="text-sm text-blue-600 cursor-pointer hover:underline">
                                        上傳大頭照
                                        <input type="file" id="photo" class="hidden" accept="image/*">
                                    </label>
                                </div>
                                <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                     <div><label class="block text-sm font-medium">姓名*</label><input type="text" id="name" required class="w-full mt-1 p-2 border rounded-md" value="${user?.name || ''}"></div>
                                     <div><label class="block text-sm font-medium">員工編號</label><input type="text" id="employeeId" class="w-full mt-1 p-2 border rounded-md" value="${user?.employeeId || ''}"></div>
                                     <div><label class="block text-sm font-medium">登入帳號*</label><input type="text" id="username" ${isEditMode ? 'disabled' : 'required'} class="w-full mt-1 p-2 border rounded-md ${isEditMode ? 'bg-gray-100' : ''}" value="${user?.username || ''}"></div>
                                     <div><label class="block text-sm font-medium">Email*</label><input type="email" id="email" ${isEditMode ? 'disabled' : 'required'} class="w-full mt-1 p-2 border rounded-md ${isEditMode ? 'bg-gray-100' : ''}" value="${user?.email || ''}"></div>
                                     <div class="sm:col-span-2"><label class="block text-sm font-medium">密碼</label><input type="password" id="password" ${isEditMode ? '' : 'required'} class="w-full mt-1 p-2 border rounded-md" placeholder="${isEditMode ? '留空則不修改' : '此為必填項'}"></div>
                                </div>
                            </div>
                            <hr>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                <div><label class="block text-sm font-medium">帳號角色</label><select id="role" class="w-full mt-1 p-2 border rounded-md">${roleOptions.map(r => `<option value="${r}" ${user?.role === r ? 'selected' : ''}>${roleNameMapping[r]}</option>`).join('')}</select></div>
                                <div><label class="block text-sm font-medium">狀態</label><select id="status" class="w-full mt-1 p-2 border rounded-md">${Object.entries(statusOptions).map(([key, value]) => `<option value="${key}" ${user?.status === key ? 'selected' : ''}>${value}</option>`).join('')}</select></div>
                                <div><label class="block text-sm font-medium">手機號碼</label><input type="tel" id="phoneNumber" class="w-full mt-1 p-2 border rounded-md" value="${user?.phoneNumber || ''}"></div>
                                <div><label class="block text-sm font-medium">身分證號</label><input type="text" id="nationalId" class="w-full mt-1 p-2 border rounded-md" value="${user?.nationalId || ''}"></div>
                                <div class="md:col-span-2"><label class="block text-sm font-medium">出生年月日</label><input type="date" id="dob" class="w-full mt-1 p-2 border rounded-md" value="${user?.dob || ''}"></div>
                                <div class="md:col-span-3"><label class="block text-sm font-medium">服務社區</label><input type="text" id="serviceCommunity" class="w-full mt-1 p-2 border rounded-md" value="${user?.serviceCommunity || ''}"></div>
                            </div>
                            <div><label class="block text-sm font-medium">相關證照</label><textarea id="certifications" rows="2" class="w-full mt-1 p-2 border rounded-md">${user?.certifications || ''}</textarea></div>
                            <div><label class="block text-sm font-medium">備註</label><textarea id="remarks" rows="2" class="w-full mt-1 p-2 border rounded-md">${user?.remarks || ''}</textarea></div>

                            <div class="mt-6 flex justify-end space-x-4"><button type="button" id="cancel-user-modal" class="px-4 py-2 bg-gray-200 rounded-md">取消</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">儲存</button></div>
                        </form>
                    </div>
                </div>`;
            
            modalContainer.querySelector('#cancel-user-modal').addEventListener('click', closeModal);
            modalContainer.querySelector('#user-modal-backdrop').addEventListener('click', e => { if (e.target.id === 'user-modal-backdrop') closeModal(); });
            modalContainer.querySelector('#photo').addEventListener('change', e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('avatar-preview').src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function showCommunityModal(community = null) {
            const isEditMode = community !== null;
            const title = isEditMode ? '編輯社區資料' : '新增社區';
            
            modalContainer.innerHTML = `
                <div class="modal-backdrop" id="community-modal-backdrop">
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">${title}</h3>
                        <form id="community-modal-form" class="space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium">區域</label><input type="text" id="region" class="w-full mt-1 p-2 border rounded-md" value="${community?.region || ''}"></div>
                                <div><label class="block text-sm font-medium">社區編號</label><input type="text" id="communityId" class="w-full mt-1 p-2 border rounded-md" value="${community?.communityId || ''}"></div>
                                <div class="sm:col-span-2"><label class="block text-sm font-medium">社區名稱*</label><input type="text" id="name" required class="w-full mt-1 p-2 border rounded-md" value="${community?.name || ''}"></div>
                                <div class="sm:col-span-2"><label class="block text-sm font-medium">社區地址</label><input type="text" id="address" class="w-full mt-1 p-2 border rounded-md" value="${community?.address || ''}"></div>
                                <div><label class="block text-sm font-medium">社區戶數</label><input type="number" id="householdCount" class="w-full mt-1 p-2 border rounded-md" value="${community?.householdCount || ''}"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">委員名單</label>
                                <div id="committee-list" class="space-y-2 mt-1">
                                    <!-- 動態委員名單 -->
                                </div>
                                <button type="button" class="add-committee-member mt-2 text-sm text-blue-600 hover:underline">新增委員</button>
                            </div>
                            <div class="mt-6 flex justify-end space-x-4"><button type="button" id="cancel-community-modal" class="px-4 py-2 bg-gray-200 rounded-md">取消</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">儲存</button></div>
                        </form>
                    </div>
                </div>`;
            addCommitteeMemberRow(); // Add the first row by default
            modalContainer.querySelector('#cancel-community-modal').addEventListener('click', closeModal);
        }

        function addCommitteeMemberRow() {
            const container = document.getElementById('committee-list');
            const newRow = document.createElement('div');
            newRow.className = 'flex items-center gap-2';
            newRow.innerHTML = `
                <input type="text" class="w-1/3 p-2 border rounded-md committee-title" placeholder="職稱 (如:主委)">
                <input type="text" class="flex-grow p-2 border rounded-md committee-name" placeholder="姓名">
                <button type="button" class="remove-committee-member text-red-500 p-1 rounded-full hover:bg-red-100">${Icon('trash', 'w-4 h-4')}</button>
            `;
            container.appendChild(newRow);
        }

        function showDeleteConfirmModal(userId, userName) {
            modalContainer.innerHTML = `
                <div class="modal-backdrop" id="delete-modal-backdrop">
                    <div class="modal-content max-w-sm">
                        <h3 class="text-lg font-bold">確認刪除</h3>
                        <p class="mt-2 text-sm text-gray-600">您確定要刪除員工「${userName}」嗎？此操作將永久移除該員工的資料且無法復原。</p>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button id="cancel-delete-modal" class="px-4 py-2 bg-gray-200 rounded-md">取消</button>
                            <button id="confirm-delete-btn" data-userid="${userId}" class="px-4 py-2 bg-red-600 text-white rounded-md">確認刪除</button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.querySelector('#cancel-delete-modal').addEventListener('click', closeModal);
            modalContainer.querySelector('#delete-modal-backdrop').addEventListener('click', e => { if (e.target.id === 'delete-modal-backdrop') closeModal(); });
            modalContainer.querySelector('#confirm-delete-btn').addEventListener('click', e => handleDeleteUser(e.target.dataset.userid));
        }

        function closeModal() { modalContainer.innerHTML = ''; }

        // --- 資料處理函式 ---
        async function handleAuthSubmit(e) {
            e.preventDefault();
            const feedbackEl = document.getElementById('auth-feedback');
            feedbackEl.textContent = '登入中...';
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const usersRef = collection(db, `apps/${appId}/users`);
                const q = query(usersRef, where("username", "==", username));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    feedbackEl.textContent = '帳號或密碼錯誤。';
                    return;
                }
                const userDoc = querySnapshot.docs[0];
                const userUID = userDoc.id;
                const userEmail = userDoc.data().email;

                await signInWithEmailAndPassword(auth, userEmail, password);
            } catch (error) {
                console.error("Login error:", error);
                feedbackEl.textContent = '帳號或密碼錯誤。';
            }
        }
        async function handleSignOut() { await signOut(auth); }
        
        async function handleUserSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = '儲存中...';

            const userId = form.querySelector('#userId').value;
            const isEditMode = !!userId;

            const userData = {
                name: form.querySelector('#name').value,
                employeeId: form.querySelector('#employeeId').value,
                role: form.querySelector('#role').value,
                status: form.querySelector('#status').value,
                phoneNumber: form.querySelector('#phoneNumber').value,
                nationalId: form.querySelector('#nationalId').value,
                dob: form.querySelector('#dob').value,
                serviceCommunity: form.querySelector('#serviceCommunity').value,
                certifications: form.querySelector('#certifications').value,
                remarks: form.querySelector('#remarks').value,
            };

            try {
                if (isEditMode) {
                    // --- 編輯模式 ---
                    const userDocId = userId;
                    const photoFile = form.querySelector('#photo').files[0];
                    if (photoFile) {
                        const storageRef = ref(storage, `profile_pictures/${userDocId}/${Date.now()}_${photoFile.name}`);
                        const snapshot = await uploadBytes(storageRef, photoFile);
                        userData.photoURL = await getDownloadURL(snapshot.ref);
                    }
                    await setDoc(doc(db, `apps/${appId}/users`, userDocId), userData, { merge: true });
                    alert('員工資料已更新。');

                } else {
                    // --- 新增模式 ---
                    const email = form.querySelector('#email').value;
                    const password = form.querySelector('#password').value;
                    const username = form.querySelector('#username').value;
                    
                    if (!password || !email || !username) {
                        throw new Error("新增員工時，登入帳號、Email 和密碼為必填項。");
                    }
                    
                    // 檢查帳號和 Email 是否重複
                    const usersRef = collection(db, `apps/${appId}/users`);
                    const usernameQuery = query(usersRef, where("username", "==", username));
                    const emailQuery = query(usersRef, where("email", "==", email));
                    const [usernameSnapshot, emailSnapshot] = await Promise.all([getDocs(usernameQuery), getDocs(emailQuery)]);
                    if (!usernameSnapshot.empty) {
                         throw new Error(`登入帳號 "${username}" 已被使用。`);
                    }
                     if (!emailSnapshot.empty) {
                        throw new Error(`Email "${email}" 已被使用。`);
                    }

                    userData.email = email;
                    userData.username = username;
                    userData.createdAt = serverTimestamp();

                    const tempAppName = `user-creation-${Date.now()}`;
                    const tempApp = initializeApp(firebaseConfig, tempAppName);
                    const tempAuth = getAuth(tempApp);
                    let newUid = null;

                    try {
                        const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                        newUid = userCredential.user.uid;
                    } catch(authError) {
                        if (authError.code === 'auth/weak-password') {
                             throw new Error('密碼強度不足，至少需要 6 個字元。');
                        } else if (authError.code === 'auth/email-already-in-use') {
                            throw new Error('此 Email 已被註冊，請更換一個。');
                        }
                        throw new Error('建立登入權限時發生未知錯誤。');
                    } finally {
                        await deleteApp(tempApp);
                    }

                    if (!newUid) {
                        throw new Error("建立 Firebase Authentication 使用者失敗。");
                    }

                    const photoFile = form.querySelector('#photo').files[0];
                    if (photoFile) {
                        const storageRef = ref(storage, `profile_pictures/${newUid}/${Date.now()}_${photoFile.name}`);
                        const snapshot = await uploadBytes(storageRef, photoFile);
                        userData.photoURL = await getDownloadURL(snapshot.ref);
                    }

                    await setDoc(doc(db, `apps/${appId}/users`, newUid), userData);
                    alert('員工帳號與資料已成功建立！');
                }

                closeModal();
                await renderContent('userManagement');

            } catch (error) {
                console.error("儲存員工資料失敗:", error);
                alert(`儲存失敗：${error.message}`);
            } finally {
                // 無論成功失敗，最後都重置按鈕
                if (document.body.contains(submitButton)) {
                    submitButton.disabled = false;
                    submitButton.textContent = '儲存';
                }
            }
        }
        
        async function handleCommunitySubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = '儲存中...';

            const committeeRows = form.querySelectorAll('#committee-list > div');
            const committee = Array.from(committeeRows).map(row => ({
                title: row.querySelector('.committee-title').value,
                name: row.querySelector('.committee-name').value
            })).filter(member => member.title && member.name);

            const communityData = {
                region: form.querySelector('#region').value,
                communityId: form.querySelector('#communityId').value,
                name: form.querySelector('#name').value,
                address: form.querySelector('#address').value,
                householdCount: form.querySelector('#householdCount').value,
                committee: committee,
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, `apps/${appId}/communities`), communityData);
                alert('社區資料已成功建立！');
                closeModal();
                await renderContent('communities');
            } catch (error) {
                console.error("儲存社區資料失敗:", error);
                alert(`儲存失敗：${error.message}`);
            } finally {
                 if (document.body.contains(submitButton)) {
                    submitButton.disabled = false;
                    submitButton.textContent = '儲存';
                }
            }
        }


        async function handleDeleteUser(userId) {
            try {
                await deleteDoc(doc(db, `apps/${appId}/users`, userId));
                alert('員工資料已刪除。\n\n請注意：為安全起見，系統不會自動刪除 Firebase Authentication 中的登入帳號，請手動前往 Firebase 控制台刪除該使用者的登入權限。');
                closeModal();
                await renderContent('userManagement');
            } catch (error) {
                console.error("刪除員工失敗:", error);
                alert(`刪除失敗：${error.message}`);
            }
        }


        function handleExportCSV() {
            if (state.users.length === 0) {
                alert("沒有可匯出的資料。");
                return;
            }
            const headers = ['姓名', '員工編號', 'Email', '角色', '手機號碼', '身分證號', '出生年月日', '服務社區', '相關證照', '備註', '大頭照URL', '登入帳號', '狀態'];
            const rows = state.users.map(user => [
                user.name || '',
                user.employeeId || '',
                user.email || '',
                user.role || '',
                user.phoneNumber || '',
                user.nationalId || '',
                user.dob || '',
                user.serviceCommunity || '',
                `"${(user.certifications || '').replace(/"/g, '""')}"`,
                `"${(user.remarks || '').replace(/"/g, '""')}"`,
                user.photoURL || '',
                user.username || '',
                user.status || ''
            ].join(','));

            const csvContent = "\uFEFF" + [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "員工資料.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function handleImportCSV(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const csv = event.target.result;
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 2) {
                    alert('CSV 檔案格式錯誤或沒有資料。');
                    return;
                }
                const headers = lines[0].split(',').map(h => h.trim());
                const data = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const entry = {};
                    headers.forEach((header, i) => {
                        entry[header] = values[i] ? values[i].trim().replace(/^"|"$/g, '') : '';
                    });
                    return entry;
                });
                console.log("解析到的 CSV 資料:", data);
                alert(`成功解析到 ${data.length} 筆資料。\n請查看 Console 獲取詳情。\n(注意：此版本尚未實作自動匯入功能)`);
            };
            reader.readAsText(file, 'UTF-8');
            e.target.value = '';
        }
        
        // --- 資料獲取函式 ---
        async function fetchAllUsers() {
            try {
                const usersCollectionRef = collection(db, `apps/${appId}/users`);
                const q = query(usersCollectionRef, orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                state.users = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) { 
                console.error("獲取使用者列表失敗:", error);
                if (error.code === 'failed-precondition') {
                    alert("資料庫需要建立索引來支援排序，請按 F12 打開開發者工具，並點擊 Console 中的連結來自動建立索引。");
                }
            }
        }
        async function fetchSchedules() { state.schedules = []; }
        async function fetchRecords() { state.records = []; }
        async function fetchTasks() { state.tasks = []; }
        async function fetchCommunities() {
             try {
                const communitiesCollectionRef = collection(db, `apps/${appId}/communities`);
                const q = query(communitiesCollectionRef, orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                state.communities = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) { 
                console.error("獲取社區列表失敗:", error);
                 if (error.code === 'failed-precondition') {
                    alert("資料庫需要為 'communities' 集合建立索引，請按 F12 打開開發者工具，並點擊 Console 中的連結來自動建立索引。");
                }
            }
        }

        // --- 初始化應用程式 ---
        onAuthStateChanged(auth, async (firebaseUser) => {
            if (firebaseUser) {
                const userDocRef = doc(db, `apps/${appId}/users`, firebaseUser.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    state.user = { uid: firebaseUser.uid, id: userDocSnap.id, ...userDocSnap.data() };
                } else {
                    console.warn("Firestore user document not found for UID:", firebaseUser.uid);
                    state.user = { uid: firebaseUser.uid, id: firebaseUser.uid, email: firebaseUser.email, role: 'Employee', name: '資料遺失' };
                }
            } else {
                state.user = null;
            }
            state.loading = false;
            await renderApp();
        });

        // 啟動事件監聽
        setupEventListeners();

    </script>
</body>
</html>
