<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西北保全勤務管理系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for JSX -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        window.firebase = {
            initializeApp,
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut,
            getFirestore,
            doc,
            getDoc
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        function startApp() {
            const { useState, useEffect, useMemo } = React;
            const { initializeApp: initializeFirebaseApp } = window.firebase;
            const { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } = window.firebase;
            const { getFirestore, doc, getDoc } = window.firebase;
            const { Home, ShieldCheck, CalendarClock, MapPin, Award, UserPlus, FileText, Settings, LogOut, Briefcase, AlertTriangle } = window.lucide;

            // --- 1. Firebase 設定 ---
            const firebaseConfig = {
              apiKey: "AIzaSyAUWD4qFvV88umGvzyozFuyo7WhT6QidsU",
              authDomain: "nwcom-security-system.firebaseapp.com",
              projectId: "nwcom-security-system",
              storageBucket: "nwcom-security-system.firebasestorage.app",
              messagingSenderId: "439911862368",
              appId: "1:439911862368:web:64dd8bf7a8e44d81687305",
              measurementId: "G-H8GLDCW27X"
            };

            // --- 設定檢查元件 ---
            function ConfigError() {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-red-50">
                        <div className="max-w-2xl w-full bg-white p-8 rounded-lg shadow-lg border-2 border-red-200 text-center">
                            <AlertTriangle className="mx-auto h-16 w-16 text-red-500" />
                            <h1 className="mt-4 text-3xl font-bold text-gray-900">系統設定錯誤</h1>
                            <p className="mt-4 text-gray-600">
                                系統偵測到您尚未設定 Firebase。請打開 <code>index.html</code> 檔案，找到 <code>firebaseConfig</code> 物件，並將其內容替換為您自己的 Firebase 專案設定。
                            </p>
                        </div>
                    </div>
                );
            }

            if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.apiKey) {
                ReactDOM.render(<ConfigError />, document.getElementById('root'));
                return;
            }

            // 初始化 Firebase
            const app = initializeFirebaseApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // --- 2. 應用程式主元件 ---
            function App() {
                const [user, setUser] = useState(null);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState('');

                useEffect(() => {
                    const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
                        if (firebaseUser) {
                            try {
                                const userDocRef = doc(db, "users", firebaseUser.uid);
                                const userDocSnap = await getDoc(userDocRef);
                                if (userDocSnap.exists()) {
                                    setUser({ uid: firebaseUser.uid, email: firebaseUser.email, ...userDocSnap.data() });
                                    setError(''); // 成功登入後清除錯誤訊息
                                } else {
                                    console.error("Firestore Error: User document not found for UID:", firebaseUser.uid);
                                    setError("登入成功，但找不到您的使用者設定檔。請聯絡管理員確認已在資料庫中建立您的資料。");
                                    await signOut(auth);
                                    setUser(null);
                                }
                            } catch (e) {
                                console.error("Error fetching user data:", e);
                                setError("讀取使用者資料時發生錯誤，請檢查網路連線或聯繫管理員。");
                                await signOut(auth);
                                setUser(null);
                            }
                        } else {
                            setUser(null);
                        }
                        setLoading(false);
                    });
                    return () => unsubscribe();
                }, []);

                const handleLogin = async (email, password) => {
                    setLoading(true);
                    setError('');
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (error) {
                        console.error("Login failed:", error.code);
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                            setError("登入失敗，請檢查您的帳號或密碼。");
                        } else {
                            setError("登入時發生未知錯誤，請稍後再試。");
                        }
                    }
                    setLoading(false);
                };

                const handleLogout = async () => {
                    await signOut(auth);
                    setUser(null);
                    // 登出後不清空錯誤，以便保留登入頁面可能需要的錯誤訊息
                };

                if (loading) {
                    return (
                        <div className="flex items-center justify-center h-screen">
                            <div className="w-16 h-16 border-4 border-blue-500 border-dashed rounded-full animate-spin"></div>
                        </div>
                    );
                }

                return (
                    <div>
                        {user ? <Dashboard user={user} onLogout={handleLogout} /> : <LoginPage onLogin={handleLogin} error={error} />}
                    </div>
                );
            }

            // --- 3. 登入頁面元件 ---
            function LoginPage({ onLogin, error }) {
                const [email, setEmail] = useState('');
                const [password, setPassword] = useState('');
                const handleSubmit = (e) => {
                    e.preventDefault();
                    onLogin(email, password);
                };
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
                        <div className="max-w-md w-full space-y-8">
                            <div>
                                <ShieldCheck className="mx-auto h-12 w-auto text-blue-600" />
                                <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">西北保全勤務管理系統</h2>
                            </div>
                            <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
                                <div className="rounded-md shadow-sm -space-y-px">
                                    <div><input id="email-address" name="email" type="email" required className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="電子郵件" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                                    <div><input id="password" name="password" type="password" required className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="密碼" value={password} onChange={(e) => setPassword(e.target.value)} /></div>
                                </div>
                                {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-center"><span className="block sm:inline">{error}</span></div>}
                                <div><button type="submit" className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">登入</button></div>
                            </form>
                        </div>
                    </div>
                );
            }

            // --- 4. 儀表板主元件 ---
            function Dashboard({ user, onLogout }) {
                const [currentPage, setCurrentPage] = useState('home');
                const [isSidebarOpen, setIsSidebarOpen] = useState(true);

                const roleName = useMemo(() => {
                    const roles = {'Admin': '系統管理員', 'Manager': '高階管理者', 'Junior Manager': '初階管理者', 'Employee': '員工'};
                    return roles[user.role] || '未知角色';
                }, [user.role]);

                const navItems = useMemo(() => {
                    const allItems = {
                        'home': { label: '儀表板首頁', icon: Home, roles: ['Admin', 'Manager', 'Junior Manager', 'Employee'] },
                        'schedule': { label: '勤務排班', icon: CalendarClock, roles: ['Admin', 'Manager', 'Junior Manager', 'Employee'] },
                        'clockIn': { label: 'GPS打卡', icon: MapPin, roles: ['Employee'] },
                        'records': { label: '獎懲記錄', icon: Award, roles: ['Admin', 'Manager', 'Junior Manager', 'Employee'] },
                        'reports': { label: '數據報表', icon: FileText, roles: ['Admin', 'Manager', 'Junior Manager'] },
                        'tasks': { label: '任務指派', icon: Briefcase, roles: ['Admin', 'Manager', 'Junior Manager'] },
                        'userManagement': { label: '帳號管理', icon: UserPlus, roles: ['Admin'] },
                        'systemSettings': { label: '系統設定', icon: Settings, roles: ['Admin'] },
                    };
                    return Object.entries(allItems).filter(([key, value]) => value.roles.includes(user.role)).map(([key, value]) => ({ id: key, ...value }));
                }, [user.role]);

                return (
                    <div className="flex h-screen bg-gray-100">
                        <aside className={`bg-gray-800 text-white flex-shrink-0 ${isSidebarOpen ? 'w-64' : 'w-20'} transition-all duration-300 ease-in-out`}>
                            <div className="p-4 flex items-center justify-between h-16 border-b border-gray-700">
                                <ShieldCheck className="h-8 w-8 text-blue-400" />
                                {isSidebarOpen && <span className="text-xl font-bold">西北保全</span>}
                            </div>
                            <nav className="mt-4">
                                {navItems.map(item => (<a key={item.id} href="#" onClick={() => setCurrentPage(item.id)} className={`flex items-center py-3 px-4 my-1 transition-colors duration-200 ${isSidebarOpen ? '' : 'justify-center'} ${currentPage === item.id ? 'bg-gray-700' : 'hover:bg-gray-700'}`}><item.icon className="h-6 w-6" />{isSidebarOpen && <span className="mx-4">{item.label}</span>}</a>))}
                            </nav>
                            <div className="absolute bottom-0 w-full"><a href="#" onClick={onLogout} className={`flex items-center py-3 px-4 my-1 transition-colors duration-200 hover:bg-red-500 ${isSidebarOpen ? '' : 'justify-center'}`}><LogOut className="h-6 w-6"/>{isSidebarOpen && <span className="mx-4">登出</span>}</a></div>
                        </aside>
                        <div className="flex-1 flex flex-col overflow-hidden">
                            <header className="flex justify-between items-center p-4 bg-white border-b">
                                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="text-gray-500 focus:outline-none"><svg className="h-6 w-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6H20M4 12H20M4 18H11Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg></button>
                                <div className="flex items-center">
                                    <div className="text-right mr-4"><p className="font-semibold">{user.name || user.email}</p><p className="text-sm text-gray-500">{roleName}</p></div>
                                    <img className="h-10 w-10 rounded-full object-cover" src={`https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || user.email)}&background=0D8ABC&color=fff`} alt="avatar" />
                                </div>
                            </header>
                            <main className="flex-1 overflow-x-hidden overflow-y-auto bg-gray-200 p-6"><PageContent page={currentPage} user={user} /></main>
                        </div>
                    </div>
                );
            }
            
            // --- 5. 頁面內容元件 ---
            function PageContent({ page, user }) {
                const commonCardStyle = "bg-white p-6 rounded-lg shadow-md";
                switch (page) {
                    case 'home': return (<div><h1 className="text-3xl font-bold text-gray-800 mb-4">歡迎回來, {user.name || user.email}!</h1><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><div className={commonCardStyle}><h2 className="text-xl font-semibold mb-2">今日勤務</h2><p className="text-gray-600">08:00 - 17:00</p><p className="text-gray-600">A社區 - 大門崗哨</p></div><div className={commonCardStyle}><h2 className="text-xl font-semibold mb-2">本月考核分數</h2><p className="text-3xl font-bold text-green-500">95</p></div><div className={commonCardStyle}><h2 className="text-xl font-semibold mb-2">待辦事項</h2><p className="text-gray-600">3 項未完成</p></div><div className={commonCardStyle}><h2 className="text-xl font-semibold mb-2">最新公告</h2><p className="text-gray-600">中秋節勤務調整通知</p></div></div></div>);
                    case 'schedule': return <div><h1 className="text-2xl font-bold">勤務排班</h1><p>這裡是排班表的頁面。</p></div>;
                    case 'clockIn': return <div><h1 className="text-2xl font-bold">GPS打卡</h1><p>這裡是GPS打卡的頁面。</p></div>;
                    case 'records': return <div><h1 className="text-2xl font-bold">獎懲記錄</h1><p>這裡是獎懲記錄的頁面。</p></div>;
                    case 'reports': return <div><h1 className="text-2xl font-bold">數據報表</h1><p>這裡是數據報表的頁面。</p></div>;
                    case 'tasks': return <div><h1 className="text-2xl font-bold">任務指派</h1><p>這裡是任務指派的頁面。</p></div>;
                    case 'userManagement': return <div><h1 className="text-2xl font-bold">帳號管理</h1><p>這裡是帳號管理的頁面。</p></div>;
                    case 'systemSettings': return <div><h1 className="text-2xl font-bold">系統設定</h1><p>這裡是系統設定的頁面。</p></div>;
                    default: return <div><h1 className="text-2xl font-bold">頁面不存在</h1></div>;
                }
            }

            ReactDOM.render(<App />, document.getElementById('root'));
        }

        function checkAndStart() {
            try {
                if (window.React && window.ReactDOM && window.lucide && window.firebase) {
                    startApp();
                } else {
                    setTimeout(checkAndStart, 50);
                }
            } catch (e) {
                console.error("Critical application error:", e);
                const root = document.getElementById('root');
                root.innerHTML = `<div style="font-family: sans-serif; padding: 2rem; text-align: center; background-color: #fff5f5; border: 1px solid #fecaca; border-radius: 0.5rem; margin: 2rem;">
                    <h1 style="color: #b91c1c; font-size: 1.5rem; font-weight: bold;">應用程式載入失敗</h1>
                    <p style="margin-top: 1rem; color: #374151;">發生了無法預期的嚴重錯誤，導致程式無法啟動。</p>
                    <p style="margin-top: 0.5rem; color: #52525b;">請檢查瀏覽器開發者工具(F12)中的 Console (主控台) 標籤，以獲取詳細的錯誤訊息。</p>
                    <pre style="background-color: #f3f4f6; padding: 1rem; text-align: left; margin-top: 1.5rem; border-radius: 0.375rem; white-space: pre-wrap; word-break: break-all; font-family: monospace; color: #dc2626; font-size: 0.875rem;">${e.stack}</pre>
                </div>`;
            }
        }

        checkAndStart();
    </script>
</body>
</html>
