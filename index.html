<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西北保全勤務管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 避免 Tailwind CSS 預設樣式影響，確保 body 和 html 佔滿整個視窗高度 */
        html, body, #app {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        /* 微調滾動條樣式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app">
        <!-- 應用程式將會渲染於此 -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-xl font-semibold">載入中...</div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK 匯入 ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection,
            getDocs,
            addDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyAUWD4qFvV88umGvzyozFuyo7WhT6QidsU",
            authDomain: "nwcom-security-system.firebaseapp.com",
            projectId: "nwcom-security-system",
            storageBucket: "nwcom-security-system.firebasestorage.app",
            messagingSenderId: "439911862368",
            appId: "1:439911862368:web:64dd8bf7a8e44d81687305",
            measurementId: "G-H8GLDCW27X"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-duty-management-app';

        // --- 初始化 Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 應用程式狀態管理 ---
        let state = {
            user: null,
            loading: true,
            error: '',
            isLoginView: false,
            activeView: 'dashboard',
            isSidebarOpen: true,
            usersForManagement: [],
        };

        // --- 渲染目標 ---
        const appContainer = document.getElementById('app');

        // --- SVG 圖示組件 ---
        const Icon = (name, className = '') => {
            const icons = {
                dashboard: `<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />`,
                users: `<path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M9 3a4 4 0 110 8 4 4 0 010-8zM23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" />`,
                schedule: `<path d="M8 2v4M16 2v4M3 10h18M3 6h18M3 14h18M3 18h18" />`,
                records: `<path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2zM22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z" />`,
                profile: `<path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" />`,
                logout: `<path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9" />`,
                clock: `<path d="M22 12h-4M2 12H6M12 2v4M12 22v-4M6.34 6.34l2.83 2.83M14.83 14.83l2.83 2.83M6.34 17.66l2.83-2.83M14.83 9.17l2.83-2.83" />`,
                check: `<path d="M20 6L9 17l-5-5" />`,
                plus: `<path d="M12 5v14M5 12h14" />`,
            };
            return `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
                    ${icons[name] || ''}
                </svg>
            `;
        };
        
        // --- 渲染函式 ---

        function render() {
            appContainer.innerHTML = ''; // 清空容器

            if (state.error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'p-4 text-white bg-red-500 fixed top-0 left-0 right-0 z-50';
                errorDiv.textContent = state.error;
                appContainer.appendChild(errorDiv);
                // 3秒後自動消失
                setTimeout(() => { 
                    state.error = '';
                    if(document.body.contains(errorDiv)) errorDiv.remove();
                 }, 3000);
            }

            if (state.loading) {
                appContainer.innerHTML = `<div class="flex items-center justify-center min-h-screen bg-gray-100"><div class="text-xl font-semibold">載入中...</div></div>`;
                return;
            }

            if (state.user) {
                appContainer.innerHTML = MainLayout();
            } else {
                appContainer.innerHTML = AuthScreen();
            }
            addEventListeners();
        }
        
        // --- 組件模板 ---

        const AuthScreen = () => {
             return `
                <div class="flex items-center justify-center min-h-screen bg-gray-100">
                    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-center text-gray-800">西北保全勤務管理系統</h2>
                        <form id="auth-form" class="space-y-6">
                            ${!state.isLoginView ? `
                                <>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">姓名</label>
                                        <input type="text" id="name" value="測試管理員" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">角色 (僅供測試)</label>
                                        <select id="role" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="Admin" selected>管理員</option>
                                            <option value="Manager">高階管理者</option>
                                            <option value="Junior Manager">初階管理者</option>
                                            <option value="Employee">員工</option>
                                        </select>
                                    </div>
                                </>
                            ` : ''}
                            <div>
                                <label class="block text-sm font-medium text-gray-700">帳號 (Email)</label>
                                <input type="email" id="email" value="test@test.com" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">密碼</label>
                                <input type="password" id="password" value="123456" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div>
                                <button type="submit" class="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    ${state.isLoginView ? '登入' : '註冊'}
                                </button>
                            </div>
                        </form>
                        <p class="text-sm text-center">
                            <a href="#" id="toggle-auth-mode" class="font-medium text-blue-600 hover:text-blue-500">
                                ${state.isLoginView ? '還沒有帳號？前往註冊' : '已經有帳號？前往登入'}
                            </a>
                        </p>
                    </div>
                </div>
            `;
        };

        const MainLayout = () => {
            const roleNameMapping = {
                'Admin': '管理員', 'Manager': '高階管理者', 'Junior Manager': '初階管理者', 'Employee': '員工'
            };
            
            const getNavItems = () => {
                 const baseNav = [{ id: 'dashboard', name: '儀表板', icon: 'dashboard' }];
                 const roleNavs = {
                    Admin: [...baseNav, { id: 'userManagement', name: '帳號管理', icon: 'users' }],
                    Manager: [...baseNav, { id: 'scheduling', name: '勤務排班', icon: 'schedule' }, { id: 'records', name: '獎懲登錄', icon: 'records' }],
                    'Junior Manager': [...baseNav, { id: 'scheduling', name: '勤務排班', icon: 'schedule' }, { id: 'records', name: '獎懲登錄', icon: 'records' }],
                    Employee: [...baseNav, { id: 'mySchedule', name: '我的班表', icon: 'schedule' }, { id: 'myRecords', name: '我的獎懲', icon: 'records' }],
                };
                return roleNavs[state.user.role] || baseNav;
            }
            
            return `
                <div class="flex h-screen bg-gray-50">
                    <aside class="bg-gray-800 text-white flex flex-col transition-all duration-300 ${state.isSidebarOpen ? 'w-64' : 'w-20'}">
                        <div class="flex items-center justify-center h-16 border-b border-gray-700">
                            <h1 class="font-bold text-lg ${state.isSidebarOpen ? '' : 'hidden'}">西北保全</h1>
                        </div>
                        <nav class="flex-1 px-4 py-4 space-y-2">
                            ${getNavItems().map(item => `
                                <a href="#" data-view="${item.id}" class="nav-link flex items-center px-4 py-2.5 rounded-md transition-colors ${state.activeView === item.id ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                    ${Icon(item.icon, 'w-6 h-6')}
                                    <span class="ml-4 ${state.isSidebarOpen ? '' : 'hidden'}">${item.name}</span>
                                </a>
                            `).join('')}
                        </nav>
                        <div class="px-4 py-4 border-t border-gray-700">
                            <a href="#" id="signout-btn" class="flex items-center px-4 py-2.5 rounded-md hover:bg-gray-700">
                                ${Icon('logout', 'w-6 h-6')}
                                <span class="ml-4 ${state.isSidebarOpen ? '' : 'hidden'}">登出</span>
                            </a>
                        </div>
                    </aside>
                    <div class="flex-1 flex flex-col">
                        <header class="flex items-center justify-between h-16 px-6 bg-white border-b">
                            <button id="toggle-sidebar" class="p-2 -ml-2 rounded-md focus:outline-none focus:ring">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                            </button>
                            <div class="flex items-center space-x-4">
                                ${Icon('profile', 'w-6 h-6')}
                                <div>
                                    <p class="font-semibold">${state.user.name}</p>
                                    <p class="text-sm text-gray-500">${roleNameMapping[state.user.role]}</p>
                                </div>
                            </div>
                        </header>
                        <main id="main-content" class="flex-1 p-6 overflow-y-auto bg-gray-100">
                           ${renderContent()}
                        </main>
                    </div>
                </div>
            `;
        };

        const renderContent = () => {
             switch (state.activeView) {
                case 'dashboard':
                    if (state.user.role === 'Admin') return AdminDashboard();
                    if (state.user.role === 'Manager' || state.user.role === 'Junior Manager') return ManagerDashboard();
                    if (state.user.role === 'Employee') return EmployeeDashboard();
                    return `<div>儀表板</div>`;
                case 'userManagement':
                    fetchUsersForManagement();
                    return UserManagement();
                default:
                    return `<div class="p-6">頁面內容尚在建置中...</div>`;
            }
        };

        const EmployeeDashboard = () => {
            return `
                <div>
                    <h2 class="text-2xl font-bold mb-4">員工儀表板</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 bg-white rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-2">GPS 打卡</h3>
                            <p class="text-gray-600 mb-4">點擊按鈕以您目前的位置進行打卡簽到。</p>
                            <button id="clock-in-btn" class="flex items-center justify-center px-4 py-2 font-bold text-white bg-green-600 rounded-md hover:bg-green-700 disabled:bg-gray-400">
                                ${Icon('clock', 'w-5 h-5 mr-2')}
                                <span id="clock-in-text">簽到打卡</span>
                            </button>
                            <div id="clock-in-feedback" class="mt-2"></div>
                        </div>
                        <div class="p-6 bg-white rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-2">即時考核分數 (示意)</h3>
                            <p class="text-5xl font-bold text-blue-600">88</p>
                            <p class="text-gray-500 mt-2">分數將根據您的勤務表現與獎懲記錄即時更新。</p>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const ManagerDashboard = () => `
            <div>
                <h2 class="text-2xl font-bold mb-4">管理者儀表板</h2>
                <div class="p-6 bg-white rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-2">團隊總覽</h3>
                    <p>這裡將顯示您所管轄團隊的整體勤務狀況、出勤率與績效摘要。</p>
                </div>
            </div>`;

        const AdminDashboard = () => `
             <div>
                <h2 class="text-2xl font-bold mb-4">系統管理員儀表板</h2>
                <div class="p-6 bg-white rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-2">系統狀態</h3>
                    <p>這裡將顯示系統的整體使用狀況、用戶總數、以及資料庫用量等關鍵指標。</p>
                </div>
            </div>`;
            
        const UserManagement = () => {
             const roleNameMapping = { 'Admin': '管理員', 'Manager': '高階管理者', 'Junior Manager': '初階管理者', 'Employee': '員工' };

             if (state.usersForManagement.length === 0) {
                 return `<div>讀取使用者資料中...</div>`;
             }

             return `
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">帳號管理</h2>
                        <button class="flex items-center px-4 py-2 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700">
                            ${Icon('plus', 'w-5 h-5 mr-2')} 新增使用者
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">角色</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">註冊時間</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${state.usersForManagement.map(user => `
                                    <tr key="${user.id}">
                                        <td class="px-6 py-4 whitespace-nowrap">${user.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                            ${roleNameMapping[user.role] || user.role}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            ${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
             `;
        };
        
        // --- 事件監聽與處理邏輯 ---
        
        function addEventListeners() {
            // 登入/註冊
            const authForm = document.getElementById('auth-form');
            if (authForm) {
                authForm.addEventListener('submit', handleAuthSubmit);
            }
            const toggleAuthMode = document.getElementById('toggle-auth-mode');
            if(toggleAuthMode) {
                toggleAuthMode.addEventListener('click', e => {
                    e.preventDefault();
                    state.isLoginView = !state.isLoginView;
                    render();
                });
            }

            // 主畫面
            const signoutBtn = document.getElementById('signout-btn');
            if (signoutBtn) {
                signoutBtn.addEventListener('click', handleSignOut);
            }
            const toggleSidebarBtn = document.getElementById('toggle-sidebar');
            if (toggleSidebarBtn) {
                toggleSidebarBtn.addEventListener('click', () => {
                    state.isSidebarOpen = !state.isSidebarOpen;
                    render();
                });
            }
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    state.activeView = link.dataset.view;
                    render();
                });
            });

            // 員工打卡
            const clockInBtn = document.getElementById('clock-in-btn');
            if(clockInBtn) {
                clockInBtn.addEventListener('click', handleClockIn);
            }
        }
        
        async function handleAuthSubmit(e) {
            e.preventDefault();
            state.error = '';
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!/^[a-zA-Z0-9@._-]+$/.test(email)) {
                state.error = '帳號只能包含英數文字與 @._-';
                render();
                return;
            }
            
            try {
                if (state.isLoginView) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const name = document.getElementById('name').value;
                    const role = document.getElementById('role').value;
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, `apps/${appId}/users`, userCredential.user.uid), {
                        name: name,
                        email: userCredential.user.email,
                        role: role,
                        createdAt: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error(error);
                if(error.code === 'auth/email-already-in-use') state.error = '此電子郵件已被註冊。';
                else if(error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') state.error = '帳號或密碼錯誤。';
                else if(error.code === 'auth/weak-password') state.error = '密碼長度需至少6個字元。';
                else state.error = '發生錯誤，請稍後再試。';
                render();
            }
        }
        
        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out error", error);
                state.error = '登出時發生錯誤。';
                render();
            }
        }
        
        async function handleClockIn() {
            const btn = document.getElementById('clock-in-btn');
            const btnText = document.getElementById('clock-in-text');
            const feedbackDiv = document.getElementById('clock-in-feedback');
            
            btn.disabled = true;
            btnText.textContent = '定位中...';
            feedbackDiv.innerHTML = '';

            if (!navigator.geolocation) {
                feedbackDiv.innerHTML = `<p class="text-red-500">您的瀏覽器不支援GPS定位。</p>`;
                btn.disabled = false;
                btnText.textContent = '簽到打卡';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    try {
                        await addDoc(collection(db, `apps/${appId}/clockIns`), {
                            userId: state.user.uid,
                            userName: state.user.name,
                            timestamp: serverTimestamp(),
                            type: 'in',
                            location: { latitude, longitude }
                        });
                        feedbackDiv.innerHTML = `<p class="text-green-600 flex items-center">${Icon('check', 'w-5 h-5 mr-2')}打卡成功！時間: ${new Date().toLocaleTimeString()}, 位置: (緯度${latitude.toFixed(4)}, 經度${longitude.toFixed(4)})</p>`;
                    } catch (e) {
                        console.error("Error adding document: ", e);
                        feedbackDiv.innerHTML = `<p class="text-red-500">打卡失敗，無法寫入資料庫。</p>`;
                    } finally {
                        btn.disabled = false;
                        btnText.textContent = '簽到打卡';
                    }
                },
                (err) => {
                    feedbackDiv.innerHTML = `<p class="text-red-500">GPS定位失敗: ${err.message}</p>`;
                    btn.disabled = false;
                    btnText.textContent = '簽到打卡';
                }
            );
        }

        async function fetchUsersForManagement() {
             try {
                const usersCollectionRef = collection(db, `apps/${appId}/users`);
                const querySnapshot = await getDocs(usersCollectionRef);
                state.usersForManagement = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Error fetching users:", error);
                state.error = "無法讀取使用者列表";
            } finally {
                // re-render the content area
                document.getElementById('main-content').innerHTML = UserManagement();
            }
        }

        // --- 初始化應用程式 ---
        onAuthStateChanged(auth, async (firebaseUser) => {
            if (firebaseUser) {
                try {
                    const userDocRef = doc(db, `apps/${appId}/users`, firebaseUser.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        state.user = { uid: firebaseUser.uid, email: firebaseUser.email, ...userDocSnap.data() };
                    } else {
                        state.user = { uid: firebaseUser.uid, email: firebaseUser.email, role: 'Employee', name: '新用戶' };
                    }
                } catch (dbError) {
                     console.error("Error fetching user data:", dbError);
                     state.error = "無法讀取使用者資料。請檢查 Firestore 安全規則。";
                     state.user = null;
                }
            } else {
                state.user = null;
            }
            state.loading = false;
            render();
        });

    </script>
</body>
</html>
